class SimpleHtml{constructor(container,options={}){if(this.container="string"==typeof container?document.querySelector(container):container,!this.container)throw new Error("SimpleHtml: Container element not found.");this.options=Object.assign({content:"",placeholder:"Start typing...",toolbar:["bold","italic","underline","|","h1","h2","h3","p","blockquote","code","removeFormat","|","insertUnorderedList","insertOrderedList","|","link","unlink","image","table","|","table_row_plus","table_row_minus","table_col_plus","table_col_minus","|","undo","redo","|","source"],buttonClass:{blockquote:"quote",insertUnorderedList:"bullet",insertOrderedList:"numbered",code:"console",image:"pic",source:"markup",table_row_plus:"add-row-down",table_row_minus:"row-red",table_col_plus:"add-col-right",table_col_minus:"col-red",removeFormat:"noformat"}},options),this.history=[],this.historyIndex=-1,this.maxHistory=50,this.allowedTags={b:[],strong:[],i:[],em:[],u:[],p:[],div:[],h1:[],h2:[],h3:[],blockquote:[],ul:[],ol:[],li:[],a:["href","target","title","rel"],img:["src","alt","width","height"],table:[],thead:[],tbody:[],tfoot:[],tr:[],td:["colspan","rowspan"],th:["colspan","rowspan"],code:[],pre:[],br:[],span:[],dd:[]},this.disallowedProtocols=["javascript:","vbscript:","data:"],this.init()}init(){this.container.innerHTML="",this.container.classList.add("bor"),this.toolbar=document.createElement("div"),this.toolbar.className="vgh-toolbar shd",this.container.appendChild(this.toolbar),this.renderToolbar(),this.initUrlForm(),this.contentArea=document.createElement("div"),this.contentArea.className="vgh-content",this.contentArea.contentEditable=!0,this.contentArea.innerHTML=this.sanitize(this.options.content),this.container.appendChild(this.contentArea),this.sourceArea=document.createElement("textarea"),this.sourceArea.className="vgh-markup",this.container.appendChild(this.sourceArea),this.initTablePicker(),this.saveHistory(),this.bindEvents()}renderToolbar(){this.toolbar.innerHTML="",this.options.toolbar.forEach(tool=>{if("|"===tool){const separator=document.createElement("span");return Object.assign(separator.style,{width:"1px",background:"#ddd",margin:"0 5px"}),void this.toolbar.appendChild(separator)}const btn=document.createElement("button");btn.type="button",btn.dataset.command=tool,btn.title=tool,btn.className="sbn vgi-"+(this.options.buttonClass[tool]||tool),tool.startsWith("table_")&&(btn.style.display="none"),btn.addEventListener("click",e=>{e.preventDefault(),this.execCommand(tool,btn)}),this.toolbar.appendChild(btn)})}getButtonLabel(tool){return{bold:"B",italic:"I",underline:"U",h1:"H1",h2:"H2",h3:"H3",p:"P",blockquote:'""',code:"{}",removeFormat:"Clear",insertUnorderedList:"‚Ä¢",insertOrderedList:"1.",link:"üîó",unlink:"‚õìÔ∏è",image:"üñºÔ∏è",table:"‚ñ¶",table_row_plus:"+Row",table_row_minus:"-Row",table_col_plus:"+Col",table_col_minus:"-Col",undo:"‚Ü©",redo:"‚Ü™",source:"</>"}[tool]||tool}bindEvents(){let timer;const updateToolbar=()=>this.updateToolbarState();this.contentArea.addEventListener("input",()=>{clearTimeout(timer),timer=setTimeout(()=>this.saveHistory(),500),updateToolbar()}),["keyup","mouseup","click"].forEach(event=>{this.contentArea.addEventListener(event,updateToolbar)}),this.contentArea.addEventListener("paste",e=>this.handlePaste(e)),document.addEventListener("mousedown",e=>{if(!this.tablePicker||"block"!==this.tablePicker.style.display)return;if(this.tablePicker.contains(e.target))return;const tableBtn=this.toolbar.querySelector('button[data-command="table"]');tableBtn&&(tableBtn===e.target||tableBtn.contains(e.target))||this.hideTablePicker()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.hideTablePicker(),this.hideUrlForm({restoreSelection:!0}))})}initUrlForm(){if(this.urlForm)return;this.urlForm=document.createElement("form"),Object.assign(this.urlForm,{className:"simplehtml-url-form",noValidate:!0}),this.urlForm.style.display="none",this.urlForm.setAttribute("aria-hidden","true"),this.urlInput=document.createElement("input"),Object.assign(this.urlInput,{type:"url",className:"txt simplehtml-url-input",placeholder:"Enter URL"}),this.urlInput.setAttribute("aria-label","URL"),this.urlUploadButton=document.createElement("span");var b=document.createElement("button");Object.assign(b,{type:"button",className:"btn vgi-folder",textContent:"Import File"}),this.urlUploadButton.append(document.createTextNode(" or "),b),this.urlFileInput=document.createElement("input"),Object.assign(this.urlFileInput,{type:"file",accept:"image/*",className:"simplehtml-url-file"}),this.urlFileInput.setAttribute("aria-hidden","true"),this.urlOkButton=document.createElement("button"),Object.assign(this.urlOkButton,{type:"submit",className:"btn sfe simplehtml-url-ok",textContent:"OK"}),this.urlCancelButton=document.createElement("button"),Object.assign(this.urlCancelButton,{type:"button",className:"btn simplehtml-url-cancel",textContent:"Cancel"}),this.urlForm.append(this.urlInput,this.urlUploadButton,this.urlOkButton,this.urlCancelButton,this.urlFileInput),this.container.appendChild(this.urlForm);const resetFileInput=()=>{this.urlFileInput.value=""},closeUrlForm=()=>{this.hideUrlForm({restoreSelection:!0}),this.contentArea.focus()};this.urlForm.addEventListener("submit",e=>{e.preventDefault(),this.applyUrl()}),this.urlUploadButton.addEventListener("click",e=>{e.preventDefault(),resetFileInput(),this.urlFileInput.click()}),this.urlFileInput.addEventListener("change",()=>{const file=this.urlFileInput.files&&this.urlFileInput.files[0];if(!file||"image"!==this.urlFormMode)return resetFileInput();if(file.type&&!file.type.startsWith("image/"))return resetFileInput();const reader=new FileReader;reader.onload=(()=>{const dataUrl="string"==typeof reader.result?reader.result:"";if(!dataUrl)return resetFileInput();this.urlInput.value=dataUrl,this.applyUrl(),resetFileInput(),closeUrlForm()}),reader.onerror=resetFileInput,reader.readAsDataURL(file)}),this.urlCancelButton.addEventListener("click",closeUrlForm),this.urlForm.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),closeUrlForm())}),this.urlFormPinned=!1,this.urlFormTarget=this.urlFormRange=this.urlFormMode=null}setUrlFormMode(mode){if(this.urlFormMode=mode,!this.urlInput)return;const isImage="image"===mode,label=isImage?"Image URL":"link"===mode?"Link URL":"URL";this.urlInput.setAttribute("aria-label",label),this.urlUploadButton&&(this.urlUploadButton.style.display=isImage?"inline-block":"none")}showUrlForm({value:value="",pin:pin=!1,focus:focus=!1}={}){this.urlForm||this.initUrlForm(),this.urlFormPinned=pin,this.urlForm.style.display="flex",this.urlForm.setAttribute("aria-hidden","false"),this.urlInput.value=value,focus&&(this.urlInput.focus(),this.urlInput.select())}hideUrlForm({restoreSelection:restoreSelection=!1}={}){this.urlForm&&(this.urlForm.style.display="none",this.urlForm.setAttribute("aria-hidden","true"),restoreSelection&&this.restoreSelection(this.urlFormRange),this.urlFormPinned=!1,this.urlFormTarget=this.urlFormRange=null,this.setUrlFormMode(null))}openUrlForm({auto:auto=!1,target:target=null,mode:mode,defaultValue:defaultValue=""}={}){const resolved=target||("image"===mode?this.getImageAtSelection():this.getLinkAtSelection());if(auto&&!resolved)return void this.hideUrlForm();this.urlFormRange=this.saveSelection(),this.urlFormTarget=resolved,this.setUrlFormMode(mode);const attr="image"===mode?"src":"href",value=resolved?resolved.getAttribute(attr)||"":defaultValue;this.showUrlForm({value:value,pin:!auto,focus:!auto})}openImageForm({auto:auto=!1,image:image=null}={}){this.openUrlForm({auto:auto,target:image,mode:"image"})}openLinkForm({auto:auto=!1,link:link=null}={}){this.openUrlForm({auto:auto,target:link,mode:"link",defaultValue:"https://"})}applyUrl(){const url=this.urlInput.value.trim();if(!url)return this.hideUrlForm({restoreSelection:!0}),void this.contentArea.focus();const target=this.urlFormTarget,isImage="image"===this.urlFormMode,isLink="link"===this.urlFormMode;if(!isImage&&!isLink)return this.hideUrlForm({restoreSelection:!0}),void this.contentArea.focus();const tagName=isImage?"IMG":"A",attr=isImage?"src":"href",command=isImage?"insertImage":"createLink";target&&target.tagName===tagName&&this.contentArea.contains(target)?target.setAttribute(attr,url):(this.contentArea.focus(),this.restoreSelection(this.urlFormRange),document.execCommand(command,!1,url)),this.saveHistory(),this.hideUrlForm(),this.updateToolbarState(),this.contentArea.focus()}syncUrlFormWithSelection(){if(!this.urlForm||this.urlFormPinned)return;if(this.sourceArea&&"block"===this.sourceArea.style.display)return void this.hideUrlForm();const link=this.getLinkAtSelection();if(link){const currentValue=link.getAttribute("href")||"";return void(this.urlFormTarget!==link||"link"!==this.urlFormMode||"none"===this.urlForm.style.display?this.openLinkForm({auto:!0,link:link}):this.urlInput.value!==currentValue&&(this.urlInput.value=currentValue))}const image=this.getImageAtSelection();if(image){const currentValue=image.getAttribute("src")||"";this.urlFormTarget!==image||"image"!==this.urlFormMode||"none"===this.urlForm.style.display?this.openImageForm({auto:!0,image:image}):this.urlInput.value!==currentValue&&(this.urlInput.value=currentValue)}else this.hideUrlForm()}getImageAtSelection(){const selection=window.getSelection();if(!selection||!selection.rangeCount)return null;const range=selection.getRangeAt(0);if(!this.contentArea.contains(range.commonAncestorContainer))return null;let node=range.commonAncestorContainer;if(!(node=1===node.nodeType?node:node.parentNode))return null;if("IMG"===node.tagName)return node;const img=node.closest&&node.closest("img");if(img&&this.contentArea.contains(img))return img;if(1===range.startContainer.nodeType){const child=range.startContainer.childNodes[range.startOffset];if(child&&1===child.nodeType&&"IMG"===child.tagName)return child}if(1===range.endContainer.nodeType){const index=Math.max(0,range.endOffset-1),child=range.endContainer.childNodes[index];if(child&&1===child.nodeType&&"IMG"===child.tagName)return child}return null}getLinkAtSelection(){const selection=window.getSelection();if(!selection||!selection.rangeCount)return null;const range=selection.getRangeAt(0);if(!this.contentArea.contains(range.commonAncestorContainer))return null;let node=range.commonAncestorContainer;if(!(node=1===node.nodeType?node:node.parentNode))return null;if("A"===node.tagName)return node;const anchor=node.closest&&node.closest("a");return anchor&&this.contentArea.contains(anchor)?anchor:null}updateToolbarState(){const selection=window.getSelection();let node=null;selection.rangeCount>0&&(node=3===(node=selection.getRangeAt(0).commonAncestorContainer).nodeType?node.parentNode:node),this.options.toolbar.forEach(tool=>{if("|"===tool)return;const btn=this.toolbar.querySelector(`button[data-command="${tool}"]`);if(btn)if(tool.startsWith("table_"))btn.style.display=node&&node.closest("div.vgh-content table")?"inline-block":"none";else if(document.queryCommandState&&!["source","undo","redo"].includes(tool))try{const active=document.queryCommandState(tool)||node&&["blockquote","code"].includes(tool)&&node.closest(`div.vgh-content ${tool}`);btn.classList.toggle("active",active)}catch(e){}});const btnUndo=this.toolbar.querySelector('button[data-command="undo"]');btnUndo&&(btnUndo.disabled=this.historyIndex<=0);const btnRedo=this.toolbar.querySelector('button[data-command="redo"]');btnRedo&&(btnRedo.disabled=this.historyIndex>=this.history.length-1),this.syncUrlFormWithSelection()}handlePaste(e){e.preventDefault();const data=e.clipboardData||window.clipboardData,html=data.getData("text/html"),text=data.getData("text"),content=html?this.sanitize(html):text.replace(/\n/g,"<br>");document.execCommand("insertHTML",!1,content)}execCommand(command,btn){switch(this.contentArea.focus(),command){case"h1":case"h2":case"h3":case"p":case"blockquote":document.execCommand("formatBlock",!1,command);break;case"code":const selection=window.getSelection();if(!selection.isCollapsed){selection.getRangeAt(0);const code=document.createElement("code");code.textContent=selection.toString(),document.execCommand("insertHTML",!1,code.outerHTML)}break;case"source":this.toggleSourceView(btn);break;case"link":this.openLinkForm();break;case"image":this.openImageForm();break;case"table":this.insertTable(btn);break;case"table_row_plus":this.modifyTable("row","add");break;case"table_row_minus":this.modifyTable("row","delete");break;case"table_col_plus":this.modifyTable("col","add");break;case"table_col_minus":this.modifyTable("col","delete");break;case"unlink":this.unlinkAtCaret();break;case"removeFormat":this.removeAllFormatting();break;case"undo":this.performUndo();break;case"redo":this.performRedo();break;default:document.execCommand(command,!1,null)}this.updateToolbarState()}removeAllFormatting(){const lines=(this.contentArea.innerText||"").replace(/\r\n/g,"\n").split("\n"),fragment=document.createDocumentFragment();lines.forEach((line,index)=>{index>0&&fragment.appendChild(document.createElement("br")),fragment.appendChild(document.createTextNode(line))}),this.contentArea.innerHTML="",this.contentArea.appendChild(fragment),this.saveHistory()}saveHistory(){const currentHtml=this.contentArea.innerHTML;this.history[this.historyIndex]!==currentHtml&&(this.history=this.history.slice(0,this.historyIndex+1),this.history.push(currentHtml),this.history.length>this.maxHistory?this.history.shift():this.historyIndex++,this.updateToolbarState())}performUndo(){this.historyIndex>0&&(this.historyIndex--,this.contentArea.innerHTML=this.history[this.historyIndex],this.updateToolbarState())}performRedo(){this.historyIndex<this.history.length-1&&(this.historyIndex++,this.contentArea.innerHTML=this.history[this.historyIndex],this.updateToolbarState())}saveSelection(){const selection=window.getSelection();return selection.rangeCount?selection.getRangeAt(0).cloneRange():null}restoreSelection(range){if(!range)return;const selection=window.getSelection();selection.removeAllRanges(),selection.addRange(range)}unlinkAtCaret(){const selection=window.getSelection();if(!selection||0===selection.rangeCount)return;if(!selection.isCollapsed)return void document.execCommand("unlink",!1,null);const range=selection.getRangeAt(0);let node=range.commonAncestorContainer;3===node.nodeType&&(node=node.parentNode);const anchor=node&&node.closest?node.closest("a"):null;if(!anchor)return void document.execCommand("unlink",!1,null);const marker=document.createElement("span");marker.setAttribute("data-sh-caret","1"),range.insertNode(marker);const parent=anchor.parentNode;for(;anchor.firstChild;)parent.insertBefore(anchor.firstChild,anchor);parent.removeChild(anchor);const newRange=document.createRange();newRange.setStartAfter(marker),newRange.collapse(!0),selection.removeAllRanges(),selection.addRange(newRange),marker.parentNode.removeChild(marker),this.saveHistory()}initTablePicker(){if(this.tablePicker)return;"static"===window.getComputedStyle(this.container).position&&(this.container.style.position="relative"),this.tablePicker=document.createElement("div"),this.tablePicker.className="simplehtml-table-picker",this.tablePicker.style.display="none",this.tablePicker.setAttribute("aria-hidden","true"),this.tablePickerLabel=document.createElement("div"),this.tablePickerLabel.className="simplehtml-table-picker-label",this.tablePickerLabel.textContent="0 x 0",this.tablePickerGrid=document.createElement("div"),this.tablePickerGrid.className="simplehtml-table-picker-grid",this.tablePickerCells=[];for(let r=1;r<=12;r++)for(let c=1;c<=12;c++){const cell=document.createElement("div");cell.className="simplehtml-table-picker-cell",cell.dataset.row=r,cell.dataset.col=c,this.tablePickerGrid.appendChild(cell),this.tablePickerCells.push(cell)}this.tablePicker.appendChild(this.tablePickerLabel),this.tablePicker.appendChild(this.tablePickerGrid),this.container.appendChild(this.tablePicker),this.tablePickerGrid.addEventListener("mouseover",e=>{const cell=e.target.closest(".simplehtml-table-picker-cell");if(!cell)return;const rows=parseInt(cell.dataset.row,10),cols=parseInt(cell.dataset.col,10);this.updateTablePickerSelection(rows,cols)}),this.tablePickerGrid.addEventListener("click",e=>{const cell=e.target.closest(".simplehtml-table-picker-cell");if(!cell)return;const rows=parseInt(cell.dataset.row,10),cols=parseInt(cell.dataset.col,10);this.insertTableWithSize(rows,cols),this.hideTablePicker()})}showTablePicker(btn){this.updateTablePickerSelection(0,0),this.tablePicker.style.display="block",this.tablePicker.setAttribute("aria-hidden","false");const containerRect=this.container.getBoundingClientRect(),pickerRect=this.tablePicker.getBoundingClientRect();let left=8,top=this.toolbar?this.toolbar.offsetHeight+8:8;if(btn){const btnRect=btn.getBoundingClientRect();left=btnRect.left-containerRect.left,top=btnRect.bottom-containerRect.top+6}left+pickerRect.width>containerRect.width&&(left=containerRect.width-pickerRect.width-6),left<0&&(left=0),top<0&&(top=0),this.tablePicker.style.left=`${left}px`,this.tablePicker.style.top=`${top}px`}hideTablePicker(){this.tablePicker&&(this.tablePicker.style.display="none",this.tablePicker.setAttribute("aria-hidden","true"),this.tablePickerSelectionRange=null)}updateTablePickerSelection(rows,cols){const label=rows&&cols?`${rows} x ${cols}`:"0 x 0";this.tablePickerLabel.textContent=label,this.tablePickerCells.forEach(cell=>{const cellRow=parseInt(cell.dataset.row,10),cellCol=parseInt(cell.dataset.col,10);cellRow<=rows&&cellCol<=cols?cell.classList.add("active"):cell.classList.remove("active")})}insertTable(btn){this.tablePicker||this.initTablePicker(),"block"!==this.tablePicker.style.display?(this.tablePickerSelectionRange=this.saveSelection(),this.showTablePicker(btn)):this.hideTablePicker()}insertTableWithSize(rows,cols){if(!rows||!cols)return;this.contentArea.focus(),this.restoreSelection(this.tablePickerSelectionRange);let html="<table><tbody>";const cells="<td></td>".repeat(cols);for(let r=0;r<rows;r++)html+=`<tr>${cells}</tr>`;html+="</tbody></table><p><br></p>",document.execCommand("insertHTML",!1,html)}modifyTable(type,action){const selection=window.getSelection();if(0===selection.rangeCount)return;let node=selection.getRangeAt(0).commonAncestorContainer;const td=(node=3===node.nodeType?node.parentNode:node).closest("div.vgh-content td")||node.closest("div.vgh-content th");if(!td)return;const tr=td.parentNode,table=tr.closest("div.vgh-content table"),rowIndex=tr.rowIndex,colIndex=Array.from(tr.children).indexOf(td);if("row"===type)if("add"===action){const newRow=table.insertRow(rowIndex+1);for(let i=0;i<tr.children.length;i++)newRow.insertCell(i).innerHTML="<br>"}else"delete"===action&&table.deleteRow(rowIndex);else if("col"===type)for(let i=0;i<table.rows.length;i++)"add"===action?table.rows[i].insertCell(colIndex+1).innerHTML="<br>":"delete"===action&&table.rows[i].cells.length>1&&table.rows[i].deleteCell(colIndex);this.saveHistory()}toggleSourceView(btn){this.hideUrlForm();const isSource="block"===this.sourceArea.style.display;isSource?(this.setValue(this.sourceArea.value),this.sourceArea.style.display="none",this.contentArea.style.display="block"):(this.sourceArea.value=this.getValue(),this.contentArea.style.display="none",this.sourceArea.style.display="block"),btn&&btn.classList.toggle("active",!isSource)}getValue(){return this.sanitize("block"===this.sourceArea.style.display?this.sourceArea.value:this.contentArea.innerHTML)}setValue(html){const clean=this.sanitize(html);this.contentArea.innerHTML=this.sourceArea.value=clean,this.saveHistory()}sanitize(html){if(!html)return"";const doc=(new DOMParser).parseFromString(html,"text/html"),cleanNode=node=>{if(3===node.nodeType)return node.cloneNode(!0);if(1!==node.nodeType)return null;const tag=node.tagName.toLowerCase();if(!this.allowedTags.hasOwnProperty(tag)){if(["script","style","iframe","object","embed"].includes(tag))return null;const fragment=document.createDocumentFragment();for(let i=0;i<node.childNodes.length;i++){const child=cleanNode(node.childNodes[i]);child&&fragment.appendChild(child)}return fragment}const el=document.createElement(tag),allowedAttrs=this.allowedTags[tag];for(let i=0;i<node.attributes.length;i++){const attr=node.attributes[i];if(allowedAttrs.includes(attr.name)){if("href"===attr.name||"src"===attr.name){const val=attr.value.toLowerCase().trim();if(this.disallowedProtocols.some(p=>val.startsWith(p))&&("src"!==attr.name||!val.startsWith("data:image/")))continue}el.setAttribute(attr.name,attr.value)}}for(let i=0;i<node.childNodes.length;i++){const child=cleanNode(node.childNodes[i]);child&&el.appendChild(child)}return el},result=document.createElement("div");for(let i=0;i<doc.body.childNodes.length;i++){const cleaned=cleanNode(doc.body.childNodes[i]);cleaned&&result.appendChild(cleaned)}return result.innerHTML}}"undefined"!=typeof module&&module.exports?module.exports=SimpleHtml:window.SimpleHtml=SimpleHtml;